<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trainer-Dashboard – Wettkampfschwimmen</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<nav>
  <div class="logo"><span>Wettkampfschwimmen</span> Trainer-Dashboard</div>
  <div class="nav-right">
    <span class="nav-user">Trainer</span>
    <button class="logout-btn" onclick="logout()">Abmelden</button>
  </div>
</nav>

<div class="container">

  <div class="stats-row">
    <div class="stat-card"><div class="stat-num" id="stat-swimmers">–</div><div class="stat-label">Schwimmer</div></div>
    <div class="stat-card"><div class="stat-num" id="stat-trainings">–</div><div class="stat-label">Trainings</div></div>
    <div class="stat-card"><div class="stat-num" id="stat-disciplines">–</div><div class="stat-label">Disziplinen</div></div>
  </div>

  <div class="tabs">
    <button class="tab-btn" data-tab="tab-trainings">Trainings</button>
    <button class="tab-btn" data-tab="tab-attendance">Anwesenheit</button>
    <button class="tab-btn" data-tab="tab-einzel">Einzel</button>
    <button class="tab-btn" data-tab="tab-mannschaft">Mannschaft</button>
    <button class="tab-btn" data-tab="tab-times">Zeiten</button>
    <button class="tab-btn" data-tab="tab-accounts">Konten</button>
  </div>

  <!-- ═══ TAB: TRAININGS VERWALTEN ═══ -->
  <div class="tab-content" id="tab-trainings">
    <div class="card">
      <h2>Training erstellen</h2>
      <div class="form-row">
        <div class="form-group"><label for="t-date">Datum</label><input type="date" id="t-date"></div>
        <div class="form-group"><label for="t-start">Von</label><input type="time" id="t-start"></div>
        <div class="form-group"><label for="t-end">Bis</label><input type="time" id="t-end"></div>
      </div>
      <button class="btn btn-primary" style="margin-top:0.5rem" onclick="createTraining()">Training anlegen</button>
    </div>

    <div class="card">
      <h2>Alle Trainings</h2>
      <div id="all-trainings"><div class="spinner">Lädt …</div></div>
    </div>
  </div>

  <!-- ═══ TAB: ANWESENHEIT ═══ -->
  <div class="tab-content" id="tab-attendance">
    <div class="card">
      <h2>Anwesenheitsübersicht</h2>
      <div class="form-group" style="max-width:300px;margin-bottom:1rem">
        <label for="select-training">Training auswählen</label>
        <select id="select-training" onchange="loadAttendanceOverview()"><option value="">– bitte wählen –</option></select>
      </div>
      <div id="attendance-overview"></div>
    </div>
  </div>

  <!-- ═══ TAB: EINZEL-DISZIPLINEN ═══ -->
  <div class="tab-content" id="tab-einzel">
    <div class="card">
      <h2>Einzeldisziplinen – Zuordnung</h2>
      <p style="margin-bottom:1rem;color:var(--text-light);font-size:0.88rem;">
        Klicke auf eine Disziplin, um Schwimmer zuzuordnen oder zu entfernen.
      </p>
      <div id="einzel-disc-list"><div class="spinner">Lädt …</div></div>
    </div>
  </div>

  <!-- ═══ TAB: MANNSCHAFT-DISZIPLINEN ═══ -->
  <div class="tab-content" id="tab-mannschaft">
    <div class="card">
      <h2>Staffeln verwalten</h2>
      <div class="form-row" style="margin-bottom:1rem;align-items:flex-end">
        <div class="form-group" style="flex:1">
          <label for="staffel-disc-select">Disziplin</label>
          <select id="staffel-disc-select">
            <option value="">– Disziplin wählen –</option>
          </select>
        </div>
        <div><button class="btn btn-primary" onclick="addStaffel()">Staffel hinzufügen</button></div>
      </div>
      <div id="staffel-list"><div class="spinner">Lädt …</div></div>
    </div>
  </div>


  <!-- ═══ TAB: ZEITEN ═══ -->
  <div class="tab-content" id="tab-times">
    <div class="card">
      <h2>Zeiten verwalten</h2>
      <div class="form-group" style="max-width:300px;margin-bottom:1rem">
        <label for="select-swimmer-times">Schwimmer</label>
        <select id="select-swimmer-times" onchange="loadTimesForSwimmer()"><option value="">– bitte wählen –</option></select>
      </div>
      <div class="section-title">Einzeldisziplinen</div>
      <div id="trainer-times-einzel"></div>
      <div class="section-title" style="margin-top:1.5rem">Mannschaftsdisziplinen</div>
      <div id="trainer-times-mannschaft"></div>
    </div>
  </div>

  <!-- ═══ TAB: KONTEN ═══ -->
  <div class="tab-content" id="tab-accounts">
    <div class="card">
      <h2>Schwimmerkonten</h2>
      <div id="accounts-list"><div class="spinner">Lädt …</div></div>
    </div>
  </div>

</div><!-- /container -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase.js"></script>
<script src="app.js"></script>
<script>
let allSwimmers = [];
let allTrainings = [];
let allDisciplines = [];

(async () => {
  const user = await checkAuth('trainer');
  if (!user) return;
  initTabs();

  // Alles parallel laden
  const [swRes, trRes, diRes] = await Promise.all([
    db.from('swimmers').select('id,name,year,user_id').order('name'),
    db.from('trainings').select('id,date,start_time,end_time').order('date'),
    db.from('disciplines').select('id,name,type,description').order('name'),
  ]);
  allSwimmers = swRes.data || [];
  allTrainings = trRes.data || [];
  allDisciplines = diRes.data || [];

  loadStats();
  renderTrainingsList();
  fillTrainingSelect();
  fillSwimmerSelect();
  loadDiscAssignments_einzel();
  fillStaffelDiscSelect();
  loadStaffeln();
  loadAccounts();
})();

// ─── STATS ─────────────────────────────────────────────────
function loadStats() {
  document.getElementById('stat-swimmers').textContent = allSwimmers.length;
  document.getElementById('stat-trainings').textContent = allTrainings.length;
  document.getElementById('stat-disciplines').textContent = allDisciplines.length;
}

// ─── TRAININGS VERWALTEN ───────────────────────────────────
async function createTraining() {
  const date = document.getElementById('t-date').value;
  const start = document.getElementById('t-start').value || null;
  const end = document.getElementById('t-end').value || null;
  if (!date) { alert('Bitte Datum eingeben.'); return; }

  const { data, error } = await db.from('trainings')
    .insert({ date, start_time: start, end_time: end }).select().single();
  if (error) { alert('Fehler: ' + error.message); return; }

  allTrainings.push(data);
  allTrainings.sort((a, b) => a.date.localeCompare(b.date));
  renderTrainingsList();
  fillTrainingSelect();
  document.getElementById('t-date').value = '';
  document.getElementById('t-start').value = '';
  document.getElementById('t-end').value = '';
}

function renderTrainingsList() {
  const c = document.getElementById('all-trainings');
  if (allTrainings.length === 0) { c.innerHTML = '<p style="color:var(--text-light)">Keine Trainings.</p>'; return; }

  let html = '<table><thead><tr><th>Datum</th><th>Uhrzeit</th><th>Zugeordnet</th><th>Aktion</th></tr></thead><tbody>';
  allTrainings.forEach(t => {
    html += `<tr id="tr-row-${t.id}">
      <td>${formatDate(t.date)}</td>
      <td>${formatSlot(t.start_time, t.end_time) || '–'}</td>
      <td><button class="btn btn-sm btn-secondary" onclick="editTrainingSwimmers('${t.id}')">Schwimmer zuordnen</button></td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteTraining('${t.id}')">Löschen</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  c.innerHTML = html;
}

async function deleteTraining(id) {
  if (!confirm('Training wirklich löschen?')) return;
  await db.from('trainings').delete().eq('id', id);
  allTrainings = allTrainings.filter(t => t.id !== id);
  renderTrainingsList();
  fillTrainingSelect();
}

// ─── SCHWIMMER ZU TRAINING ZUORDNEN ────────────────────────
async function editTrainingSwimmers(trainingId) {
  const row = document.getElementById('tr-row-' + trainingId);
  // Prüfen ob bereits offen
  const existing = document.getElementById('assign-panel-' + trainingId);
  if (existing) { existing.remove(); return; }

  // Aktuelle Zuordnungen laden
  const { data: assigned } = await db
    .from('training_swimmers').select('swimmer_id').eq('training_id', trainingId);
  const assignedIds = new Set((assigned || []).map(a => a.swimmer_id));

  const tr = document.createElement('tr');
  tr.id = 'assign-panel-' + trainingId;
  let html = '<td colspan="4" style="background:#fafcff;padding:1rem"><div class="checkbox-list">';
  allSwimmers.forEach(s => {
    html += `<label><input type="checkbox" value="${s.id}" ${assignedIds.has(s.id) ? 'checked' : ''}> ${s.name}</label>`;
  });
  html += `</div><button class="btn btn-sm btn-primary" style="margin-top:0.6rem" onclick="saveTrainingSwimmers('${trainingId}')">Zuordnung speichern</button></td>`;
  tr.innerHTML = html;
  row.after(tr);
}

async function saveTrainingSwimmers(trainingId) {
  const panel = document.getElementById('assign-panel-' + trainingId);
  const checked = [...panel.querySelectorAll('input[type=checkbox]:checked')].map(cb => cb.value);

  // Alte löschen, neue einfügen
  await db.from('training_swimmers').delete().eq('training_id', trainingId);
  if (checked.length > 0) {
    const rows = checked.map(sid => ({ training_id: trainingId, swimmer_id: sid }));
    await db.from('training_swimmers').insert(rows);
  }
  panel.remove();
  alert('Zuordnung gespeichert (' + checked.length + ' Schwimmer).');
}

// ─── SELECTS ───────────────────────────────────────────────
function fillTrainingSelect() {
  const sel = document.getElementById('select-training');
  sel.innerHTML = '<option value="">– bitte wählen –</option>';
  allTrainings.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = formatDate(t.date) + formatSlot(t.start_time, t.end_time);
    sel.appendChild(opt);
  });
}

function fillSwimmerSelect() {
  const sel = document.getElementById('select-swimmer-times');
  sel.innerHTML = '<option value="">– bitte wählen –</option>';
  allSwimmers.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.name + ' (' + s.year + ')';
    sel.appendChild(opt);
  });
}

// ─── ANWESENHEIT ───────────────────────────────────────────
async function loadAttendanceOverview() {
  const trainingId = document.getElementById('select-training').value;
  const c = document.getElementById('attendance-overview');
  if (!trainingId) { c.innerHTML = ''; return; }
  c.innerHTML = '<div class="spinner">Lädt …</div>';

  const { data: att } = await db.from('attendance').select('user_id,status').eq('training_id', trainingId);
  const attMap = {};
  (att || []).forEach(a => { attMap[a.user_id] = a.status; });

  // Nur zugeordnete Schwimmer zeigen
  const { data: assigned } = await db.from('training_swimmers').select('swimmer_id').eq('training_id', trainingId);
  const assignedIds = new Set((assigned || []).map(a => a.swimmer_id));

  const relevantSwimmers = allSwimmers.filter(s => assignedIds.has(s.id));

  let ja = 0, nein = 0, offen = 0;
  let html = '<table><thead><tr><th>Schwimmer</th><th>Jahrgang</th><th>Status</th></tr></thead><tbody>';
  relevantSwimmers.forEach(s => {
    const status = attMap[s.user_id];
    let badge;
    if (status === 'ja') { badge = '<span class="badge-ja">Ja</span>'; ja++; }
    else if (status === 'nein') { badge = '<span class="badge-nein">Nein</span>'; nein++; }
    else { badge = '<span style="color:var(--text-light);font-size:0.8rem">–</span>'; offen++; }
    html += `<tr><td>${s.name}</td><td>${s.year}</td><td>${badge}</td></tr>`;
  });
  html += '</tbody></table>';
  html += `<p style="margin-top:0.8rem;font-size:0.82rem;color:var(--text-light)">Ja: <strong>${ja}</strong> |  Nein: <strong>${nein}</strong> |  Offen: <strong>${offen}</strong></p>`;
  if (relevantSwimmers.length === 0) html = '<p style="color:var(--text-light)">Keine Schwimmer zugeordnet.</p>';
  c.innerHTML = html;
}

// ─── DISZIPLIN-ZUORDNUNG (Einzel mit Checkboxen) ──────────
async function loadDiscAssignments_einzel() {
  const discs = allDisciplines.filter(d => d.type === 'einzel');
  const container = document.getElementById('einzel-disc-list');

  if (discs.length === 0) {
    container.innerHTML = '<p style="color:var(--text-light)">Keine Einzeldisziplinen vorhanden.</p>';
    return;
  }

  const { data: allAssign } = await db.from('swimmer_disciplines').select('swimmer_id,discipline_id');
  const assignMap = {};
  (allAssign || []).forEach(a => {
    if (!assignMap[a.discipline_id]) assignMap[a.discipline_id] = new Set();
    assignMap[a.discipline_id].add(a.swimmer_id);
  });

  let html = '';
  discs.forEach(d => {
    const assigned = assignMap[d.id] || new Set();
    html += `<div class="disc-item">
      <div class="disc-item-header" onclick="toggleDisc(this)">
        <span><strong>${d.name}</strong>
          <span style="font-size:0.8rem;color:var(--text-light);margin-left:0.5rem">(${assigned.size} Schwimmer)</span>
        </span>
        <span style="font-size:0.8rem;color:var(--text-light)">▼</span>
      </div>
      <div class="disc-item-body">
        ${d.description ? '<p style="margin-bottom:0.8rem;font-style:italic">' + d.description + '</p>' : ''}
        <div class="checkbox-list" id="disc-cb-${d.id}">`;
    allSwimmers.forEach(s => {
      html += `<label><input type="checkbox" value="${s.id}" ${assigned.has(s.id) ? 'checked' : ''}> ${s.name}</label>`;
    });
    html += `</div>
        <button class="btn btn-sm btn-primary" style="margin-top:0.6rem" onclick="saveDiscAssignment_einzel('${d.id}')">Zuordnung speichern</button>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

async function saveDiscAssignment_einzel(discId) {
  const container = document.getElementById('disc-cb-' + discId);
  const checked = [...container.querySelectorAll('input[type=checkbox]:checked')].map(cb => cb.value);

  await db.from('swimmer_disciplines').delete().eq('discipline_id', discId);
  if (checked.length > 0) {
    const rows = checked.map(sid => ({ swimmer_id: sid, discipline_id: discId }));
    await db.from('swimmer_disciplines').insert(rows);
  }
  loadDiscAssignments_einzel();
}

// ─── STAFFEL-VERWALTUNG (Mannschaft) ──────────────────────
function fillStaffelDiscSelect() {
  const sel = document.getElementById('staffel-disc-select');
  sel.innerHTML = '<option value="">– Disziplin wählen –</option>';
  allDisciplines.filter(d => d.type === 'mannschaft').forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id;
    opt.textContent = d.name;
    sel.appendChild(opt);
  });
}

async function addStaffel() {
  const discId = document.getElementById('staffel-disc-select').value;
  if (!discId) { alert('Bitte zuerst eine Disziplin wählen.'); return; }

  const { error } = await db.from('staffeln').insert({ discipline_id: discId });
  if (error) { alert('Fehler: ' + error.message); return; }
  loadStaffeln();
}

async function loadStaffeln() {
  const container = document.getElementById('staffel-list');
  container.innerHTML = '<div class="spinner">Lädt …</div>';

  const { data: staffeln } = await db
    .from('staffeln')
    .select('id, discipline_id, disciplines(name)')
    .order('created_at');

  if (!staffeln || staffeln.length === 0) {
    container.innerHTML = '<p style="color:var(--text-light)">Noch keine Staffeln angelegt.</p>';
    return;
  }

  // Positionen laden
  const { data: allPos } = await db.from('relay_positions').select('staffel_id,swimmer_id,position');
  const posMap = {};
  (allPos || []).forEach(p => {
    if (!posMap[p.staffel_id]) posMap[p.staffel_id] = {};
    posMap[p.staffel_id][p.position] = p.swimmer_id;
  });

  let html = '';
  staffeln.forEach(st => {
    const positions = posMap[st.id] || {};
    const filledCount = Object.keys(positions).length;

    html += `<div class="staffel-card">
      <div class="staffel-header">
        <strong>${st.disciplines.name}</strong>
        <span style="font-size:0.82rem;color:var(--text-light)">${filledCount}/4 besetzt</span>
        <button class="btn btn-sm btn-danger" onclick="deleteStaffel('${st.id}')">Löschen</button>
      </div>
      <div class="staffel-grid" id="staffel-grid-${st.id}">`;

    for (let pos = 1; pos <= 4; pos++) {
      const currentSwimmer = positions[pos] || '';
      html += `<div class="staffel-slot">
        <label>${pos}. Teilstrecke</label>
        <select data-pos="${pos}">
          <option value="">– nicht besetzt –</option>`;
      allSwimmers.forEach(s => {
        html += `<option value="${s.id}" ${s.id === currentSwimmer ? 'selected' : ''}>${s.name}</option>`;
      });
      html += `</select></div>`;
    }

    html += `</div>
      <button class="btn btn-sm btn-primary" style="margin-top:0.6rem" onclick="saveStaffelPositions('${st.id}','${st.discipline_id}')">Speichern</button>
    </div>`;
  });
  container.innerHTML = html;
}

async function saveStaffelPositions(staffelId, discId) {
  const grid = document.getElementById('staffel-grid-' + staffelId);
  const selects = grid.querySelectorAll('select');

  const chosen = [];
  let duplicate = false;
  selects.forEach(sel => {
    if (sel.value && chosen.includes(sel.value)) { duplicate = true; }
    if (sel.value) chosen.push(sel.value);
  });
  if (duplicate) { alert('Ein Schwimmer kann nur eine Position haben.'); return; }

  await db.from('relay_positions').delete().eq('staffel_id', staffelId);

  const rows = [];
  selects.forEach(sel => {
    if (sel.value) {
      rows.push({ staffel_id: staffelId, swimmer_id: sel.value, position: parseInt(sel.dataset.pos) });
    }
  });
  if (rows.length > 0) {
    const { error } = await db.from('relay_positions').insert(rows);
    if (error) { alert('Fehler: ' + error.message); return; }
  }

  // Auch in swimmer_disciplines eintragen (damit Zeiten-Tab funktioniert)
  await db.from('swimmer_disciplines').delete().eq('discipline_id', discId);
  // Alle Schwimmer aus ALLEN Staffeln dieser Disziplin sammeln
  const { data: allStaffeln } = await db.from('staffeln').select('id').eq('discipline_id', discId);
  const staffelIds = (allStaffeln || []).map(s => s.id);
  if (staffelIds.length > 0) {
    const { data: allRP } = await db.from('relay_positions').select('swimmer_id').in('staffel_id', staffelIds);
    const uniqueSwimmers = [...new Set((allRP || []).map(r => r.swimmer_id))];
    if (uniqueSwimmers.length > 0) {
      await db.from('swimmer_disciplines').insert(uniqueSwimmers.map(sid => ({ swimmer_id: sid, discipline_id: discId })));
    }
  }

  loadStaffeln();
}

async function deleteStaffel(staffelId) {
  if (!confirm('Staffel wirklich löschen?')) return;
  await db.from('staffeln').delete().eq('id', staffelId);
  loadStaffeln();
}



// ─── ZEITEN FÜR SCHWIMMER ─────────────────────────────────
async function loadTimesForSwimmer() {
  const swId = document.getElementById('select-swimmer-times').value;
  const cE = document.getElementById('trainer-times-einzel');
  const cM = document.getElementById('trainer-times-mannschaft');
  if (!swId) { cE.innerHTML = ''; cM.innerHTML = ''; return; }

  const swimmer = allSwimmers.find(s => s.id === swId);
  if (!swimmer) return;

  // Disziplinen + Zeiten laden
  const [discRes, timeRes] = await Promise.all([
    db.from('swimmer_disciplines').select('discipline_id,disciplines(id,name,type)').eq('swimmer_id', swId),
    db.from('times').select('discipline_id,time').eq('user_id', swimmer.user_id),
  ]);

  const timeMap = {};
  (timeRes.data || []).forEach(t => { timeMap[t.discipline_id] = t.time; });

  ['einzel', 'mannschaft'].forEach(type => {
    const filtered = (discRes.data || []).filter(d => d.disciplines.type === type);
    const container = type === 'einzel' ? cE : cM;

    if (filtered.length === 0) {
      container.innerHTML = '<p style="color:var(--text-light)">Keine ' + (type === 'einzel' ? 'Einzel' : 'Mannschafts') + 'disziplinen zugewiesen.</p>';
      return;
    }

    let html = '<table><thead><tr><th>Disziplin</th><th>Zeit</th><th></th></tr></thead><tbody>';
    filtered.forEach(d => {
      const t = timeMap[d.discipline_id];
      html += `<tr>
        <td>${d.disciplines.name}</td>
        <td><input type="text" id="trt-${d.discipline_id}" placeholder="1:23,45"
          value="${t != null ? formatTime(t) : ''}"
          style="width:120px;padding:6px 10px;border:1.5px solid var(--border);border-radius:6px;font-size:0.9rem;"></td>
        <td><button class="btn btn-sm btn-secondary" onclick="trainerSaveTime('${swimmer.user_id}','${d.discipline_id}',this)">Speichern</button></td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  });
}

async function trainerSaveTime(userId, discId, btn) {
  const val = document.getElementById('trt-' + discId).value.trim();
  if (!val) { alert('Bitte Zeit eingeben.'); return; }
  const sec = parseTime(val);
  if (sec === null) { alert('Format: mm:ss,hh'); return; }
  const { error } = await db.from('times').upsert({
    user_id: userId, discipline_id: discId, time: sec
  }, { onConflict: 'user_id,discipline_id' });
  confirmBtn(btn, !error);
}

// ─── KONTEN ────────────────────────────────────────────────
async function loadAccounts() {
  const userIds = allSwimmers.map(s => s.user_id).filter(Boolean);
  const { data: usersData } = await db.from('users').select('id,active').in('id', userIds);
  const activeMap = {};
  (usersData || []).forEach(u => { activeMap[u.id] = u.active; });

  const c = document.getElementById('accounts-list');
  if (allSwimmers.length === 0) { c.innerHTML = '<p style="color:var(--text-light)">Keine Schwimmer.</p>'; return; }

  let html = '<table><thead><tr><th>Name</th><th>Jahrgang</th><th>Status</th><th>Aktion</th></tr></thead><tbody>';
  allSwimmers.forEach(s => {
    const active = activeMap[s.user_id] !== false;
    html += `<tr>
      <td>${s.name}</td><td>${s.year}</td>
      <td>${active ? '<span class="badge-aktiv">Aktiv</span>' : '<span class="badge-inaktiv">Inaktiv</span>'}</td>
      <td><button class="btn btn-sm ${active ? 'btn-danger' : 'btn-success'}" onclick="toggleAccount('${s.user_id}',${active})">${active ? 'Deaktivieren' : 'Aktivieren'}</button></td>
    </tr>`;
  });
  html += '</tbody></table>';
  c.innerHTML = html;
}

async function toggleAccount(userId, active) {
  if (!confirm(active ? 'Konto deaktivieren?' : 'Konto aktivieren?')) return;
  await db.from('users').update({ active: !active }).eq('id', userId);
  loadAccounts();
}
</script>
</body>
</html>
